{%- comment -%}
  Newsletter Section - Standalone newsletter signup
  Three design options: side-by-side, stacked, card
{%- endcomment -%}

{%- comment -%}
  Title line offset and hidden state now handled by global classes in utilities.css and animations.css
  - .section-title-line:nth-child(2) for line offset
  - [data-section-title] for hidden state
{%- endcomment -%}

<section class="newsletter-section" data-newsletter-section="{{ section.id }}">
  {% case section.settings.design %}
    {% when 'side-by-side' %}
      {% render 'newsletter-side-by-side',
        title: section.settings.title,
        text: section.settings.text,
        button_text: section.settings.button_text,
        background_color: section.settings.background_color,
        text_color: section.settings.text_color,
        privacy_text: section.settings.privacy_text,
        privacy_link: section.settings.privacy_link,
        privacy_link_text: section.settings.privacy_link_text
      %}

    {% when 'stacked' %}
      {% render 'newsletter-stacked',
        title: section.settings.title,
        text: section.settings.text,
        button_text: section.settings.button_text,
        background_color: section.settings.background_color,
        text_color: section.settings.text_color,
        privacy_text: section.settings.privacy_text,
        privacy_link: section.settings.privacy_link,
        privacy_link_text: section.settings.privacy_link_text
      %}

    {% when 'card' %}
      {% render 'newsletter-card',
        title: section.settings.title,
        text: section.settings.text,
        button_text: section.settings.button_text,
        background_color: section.settings.background_color,
        card_color: section.settings.card_color,
        text_color: section.settings.text_color,
        privacy_text: section.settings.privacy_text,
        privacy_link: section.settings.privacy_link,
        privacy_link_text: section.settings.privacy_link_text
      %}
  {% endcase %}
</section>

<script>
(function() {
  const section = document.querySelector('[data-newsletter-section="{{ section.id }}"]');
  if (!section || section.dataset.newsletterAnimInitialized) return;
  section.dataset.newsletterAnimInitialized = 'true';

  // If animations disabled, skip
  if (typeof window.shouldAnimate === 'function' && !window.shouldAnimate()) return;

  function initAnimation() {
    let gsap = window.gsap;
    if (!gsap && window.pieces && window.pieces.gsap) {
      gsap = window.pieces.gsap;
    }

    let SplitText = window.SplitText;
    if (!SplitText && window.pieces && window.pieces.SplitText) {
      SplitText = window.pieces.SplitText;
    }

    const ScrollTrigger = window.ScrollTrigger || (window.pieces && window.pieces.ScrollTrigger);

    if (!gsap || !SplitText || !ScrollTrigger) {
      setTimeout(initAnimation, 50);
      return;
    }

    const scrollStart = window.getScrollStart ? window.getScrollStart('top 70%') : 'top 70%';

    // Get elements
    const title = section.querySelector('[data-section-title]');
    const introElements = section.querySelectorAll('[data-section-intro]');

    // Create timeline for sequenced animations
    const tl = gsap.timeline({
      scrollTrigger: {
        trigger: section,
        start: scrollStart,
        once: true
      }
    });

    // 1. Title split text reveal
    if (title) {
      const split = new SplitText(title, { type: 'lines', linesClass: 'section-title-line' });

      split.lines.forEach(line => {
        const lineWrapper = document.createElement('div');
        lineWrapper.style.overflow = 'hidden';
        lineWrapper.style.display = 'block';
        line.parentNode.insertBefore(lineWrapper, line);
        lineWrapper.appendChild(line);
      });

      gsap.set(split.lines, { yPercent: 120 });

      tl.add(() => { title.style.opacity = 1; }, 0);
      tl.to(split.lines, {
        yPercent: 0,
        duration: 1.2,
        ease: 'power4.out',
        stagger: 0.1
      }, 0);
    }

    // 2. Other elements fade-in from bottom in sequence
    if (introElements.length > 0) {
      introElements.forEach((el, index) => {
        tl.to(el, {
          opacity: 1,
          y: 0,
          duration: 0.6,
          ease: 'power2.out'
        }, 0.3 + index * 0.15);
      });
    }
  }

  if (document.readyState === 'loading') {
    document.addEventListener('DOMContentLoaded', initAnimation);
  } else {
    requestAnimationFrame(initAnimation);
  }

  if (window.onSwupContentReplaced) {
    window.onSwupContentReplaced('newsletter_animation', () => {
      requestAnimationFrame(initAnimation);
    });
  }
})();
</script>

{% schema %}
{
  "name": "Newsletter",
  "settings": [
    {
      "type": "select",
      "id": "design",
      "label": "Design",
      "default": "stacked",
      "options": [
        { "value": "side-by-side", "label": "Side by side" },
        { "value": "stacked", "label": "Stacked" },
        { "value": "card", "label": "Card" }
      ]
    },
    {
      "type": "header",
      "content": "Content"
    },
    {
      "type": "text",
      "id": "title",
      "label": "Title",
      "default": "Want product news and updates? Sign up for our newsletter."
    },
    {
      "type": "textarea",
      "id": "text",
      "label": "Description",
      "default": "Subscribe to our newsletter for exclusive updates and special offers.",
      "info": "Used in Stacked and Card designs"
    },
    {
      "type": "text",
      "id": "button_text",
      "label": "Button text",
      "default": "Subscribe"
    },
    {
      "type": "header",
      "content": "Privacy notice"
    },
    {
      "type": "text",
      "id": "privacy_text",
      "label": "Privacy text",
      "default": "We care about your data. Read our",
      "info": "Displayed below the form"
    },
    {
      "type": "url",
      "id": "privacy_link",
      "label": "Privacy policy link"
    },
    {
      "type": "text",
      "id": "privacy_link_text",
      "label": "Privacy link text",
      "default": "privacy policy"
    },
    {
      "type": "header",
      "content": "Colors"
    },
    {
      "type": "color",
      "id": "background_color",
      "default": "#ffffff",
      "label": "Background color"
    },
    {
      "type": "color",
      "id": "text_color",
      "default": "#000000",
      "label": "Text color"
    },
    {
      "type": "color",
      "id": "card_color",
      "default": "#111111",
      "label": "Card color",
      "info": "Only used with Card design"
    }
  ],
  "presets": [
    {
      "name": "Newsletter",
      "category": "Marketing",
      "settings": {
        "design": "stacked"
      }
    }
  ]
}
{% endschema %}
