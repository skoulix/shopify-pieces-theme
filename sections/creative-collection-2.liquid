{%- comment -%}
  Creative Collection 2 - Unreveal Effects
  Based on Codrops UnrevealEffects by Luis Henrique Bizarro

  Features:
  - Grid layout with hover effects
  - 3 transition effect types: rotated, circle, strip
  - GSAP animations with Flip plugin
  - Swup URL updates
{%- endcomment -%}

{%- liquid
  if section.settings.collection != blank
    assign collection = collections[section.settings.collection]
  elsif collection != blank
    assign collection = collection
  else
    assign collection = collections.all
  endif

  assign effect_type = section.settings.effect_type | default: 'rotated'
-%}

<style>
  :root {
    --cc2-color-text: #000;
    --cc2-color-bg: #fff;
  }

  /* Overflow hidden utility */
  .cc2-oh {
    position: relative;
    overflow: hidden;
  }

  .cc2-oh__inner {
    display: inline-block;
    will-change: transform;
  }

  /* Main wrapper - contains both grid and preview in normal flow */
  .cc2-wrapper {
    position: relative;
    min-height: 100vh;
    background: var(--cc2-color-bg);
  }

  /* Content Grid */
  .cc2-content {
    display: grid;
    grid-template-columns: repeat(2, 1fr);
    gap: 2rem;
    padding: 4rem 2rem;
    max-width: 1400px;
    margin: 0 auto;
  }

  @media (max-width: 768px) {
    .cc2-content {
      grid-template-columns: 1fr;
      gap: 1.5rem;
      padding: 2rem 1rem;
    }
  }

  /* Hide grid when preview is open */
  .cc2-wrapper.is-preview-open .cc2-content {
    display: none;
  }

  /* Content Item */
  .cc2-content__item {
    cursor: pointer;
    position: relative;
  }

  .cc2-content__item-imgwrap {
    position: relative;
    overflow: hidden;
    aspect-ratio: 3/4;
    will-change: transform;
    background: #f0f0f0;
  }

  .cc2-content__item-img {
    width: 100%;
    height: 100%;
    object-fit: cover;
    will-change: transform;
  }

  .cc2-content__item-title {
    margin-top: 1rem;
    font-size: clamp(1.25rem, 2vw, 1.75rem);
    font-weight: 600;
    text-transform: uppercase;
    letter-spacing: 0.02em;
  }

  .cc2-content__item-title .cc2-oh__inner {
    will-change: transform, filter;
  }

  .cc2-content__item-meta {
    margin-top: 0.5rem;
    font-size: 0.875rem;
    color: #666;
  }

  /* Overlay for transition effect */
  .cc2-overlay {
    position: fixed;
    top: 50%;
    left: 50%;
    width: 150vmax;
    height: 150vmax;
    margin: -75vmax 0 0 -75vmax;
    background-color: #fff;
    pointer-events: none;
    z-index: 100;
    will-change: transform, clip-path;
  }

  /* Rotated effect - initial state */
  .cc2-wrapper[data-effect="rotated"] .cc2-overlay {
    transform: translateX(-100%) rotate(5deg);
    transform-origin: center center;
  }

  /* Circle effect - initial state */
  .cc2-wrapper[data-effect="circle"] .cc2-overlay {
    transform: none;
    clip-path: circle(0vmax at 50% 50%);
    border-radius: 0;
  }

  /* Strip effect - initial state */
  .cc2-wrapper[data-effect="strip"] .cc2-overlay {
    width: 100%;
    height: 100%;
    margin: 0;
    top: 0;
    left: 0;
    transform: translateY(100%);
  }

  /* Preview Section - part of normal page flow */
  .cc2-preview {
    display: none;
    background: var(--cc2-color-bg);
  }

  .cc2-wrapper.is-preview-open .cc2-preview {
    display: block;
  }

  /* Preview Item */
  .cc2-preview__item {
    display: none;
  }

  .cc2-preview__item.is-current {
    display: block;
  }

  /* Preview inner - matches product.liquid layout */
  .cc2-preview__item-inner {
    display: grid;
    grid-template-columns: 1fr;
    gap: 2rem;
    max-width: 80rem;
    margin: 0 auto;
    padding: 4rem 1rem;
  }

  @media (min-width: 1024px) {
    .cc2-preview__item-inner {
      grid-template-columns: 1fr 1fr;
      gap: 3rem;
      padding: 6rem 2rem;
      align-items: start;
    }
  }

  /* Image column */
  .cc2-preview__img-col {
    display: flex;
    flex-direction: column;
    gap: 1rem;
  }

  .cc2-preview__img-wrap {
    aspect-ratio: 1;
    overflow: hidden;
    border-radius: 0.5rem;
    background: #f3f4f6;
  }

  .cc2-preview__img {
    width: 100%;
    height: 100%;
    object-fit: cover;
    object-position: center;
  }

  .cc2-preview__img--placeholder {
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 4rem;
    color: #d1d5db;
  }

  /* Info column */
  .cc2-preview__info-col {
    padding-top: 1rem;
  }

  @media (min-width: 1024px) {
    .cc2-preview__info-col {
      position: sticky;
      top: 6rem;
      padding-top: 0;
    }
  }

  .cc2-preview__title {
    font-size: 1.875rem;
    font-weight: 700;
    letter-spacing: -0.025em;
    color: #111827;
    margin: 0;
  }

  .cc2-preview__price {
    margin-top: 0.75rem;
    font-size: 1.875rem;
    letter-spacing: -0.025em;
    color: #111827;
  }

  .cc2-preview__price-compare {
    margin-left: 0.5rem;
    font-size: 0.875rem;
    color: #6b7280;
    text-decoration: line-through;
  }

  .cc2-preview__description {
    margin-top: 1.5rem;
    font-size: 0.875rem;
    line-height: 1.625;
    color: #4b5563;
  }

  .cc2-preview__btn {
    display: flex;
    width: 100%;
    align-items: center;
    justify-content: center;
    gap: 0.5rem;
    margin-top: 2rem;
    padding: 0.75rem 2rem;
    background: #4f46e5;
    color: #fff;
    font-size: 1rem;
    font-weight: 500;
    border: none;
    border-radius: 0.375rem;
    cursor: pointer;
    transition: background 0.2s;
  }

  .cc2-preview__btn:hover {
    background: #4338ca;
  }

  /* Loading state */
  .cc2-wrapper.is-loading .cc2-content__item {
    opacity: 0;
    transform: translateY(30px);
  }

  .cc2-wrapper:not(.is-loading) .cc2-content__item {
    opacity: 1;
    transform: translateY(0);
    transition: opacity 0.6s ease, transform 0.6s ease;
    transition-delay: calc(var(--item-index, 0) * 0.1s);
  }
</style>

<div class="cc2-wrapper is-loading" data-effect="{{ effect_type }}" data-cc2-wrapper>
  {%- comment -%} Content Grid {%- endcomment -%}
  <div class="cc2-content" data-cc2-content>
    {% for product in collection.products limit: section.settings.products_to_show %}
      <article
        class="cc2-content__item"
        data-cc2-item="{{ forloop.index0 }}"
        data-product-url="{{ product.url }}"
        style="--item-index: {{ forloop.index0 }}"
      >
        <div class="cc2-content__item-imgwrap">
          {% if product.featured_image %}
            {{ product.featured_image | image_url: width: 1200 | image_tag:
              class: 'cc2-content__item-img',
              loading: 'lazy',
              sizes: '(max-width: 768px) 100vw, 50vw',
              widths: '400, 600, 800, 1200',
              alt: product.title
            }}
          {% else %}
            <div class="cc2-content__item-img" style="background: #f0f0f0; display: flex; align-items: center; justify-content: center;">
              <i class="ph ph-image" style="font-size: 3rem; color: #ccc;"></i>
            </div>
          {% endif %}
        </div>
        <h3 class="cc2-content__item-title">
          {% assign title_words = product.title | split: ' ' %}
          {% for word in title_words %}
            <span class="cc2-oh"><span class="cc2-oh__inner">{{ word }}{% unless forloop.last %}&nbsp;{% endunless %}</span></span>
          {% endfor %}
        </h3>
        <div class="cc2-content__item-meta">
          {{ product.vendor }} &mdash; {{ product.price | money }}
        </div>
      </article>
    {% endfor %}
  </div>

  {%- comment -%} Overlay for transition effect {%- endcomment -%}
  <div class="cc2-overlay" data-cc2-overlay></div>

  {%- comment -%} Preview container - will be filled with product section via API {%- endcomment -%}
  <div class="cc2-preview" data-cc2-preview></div>
</div>

<script>
(function() {
  const wrapper = document.querySelector('[data-cc2-wrapper]');
  if (!wrapper) return;
  if (wrapper.dataset.cc2Initialized) return;
  wrapper.dataset.cc2Initialized = 'true';

  function initUnrevealEffects() {
    if (typeof gsap === 'undefined') {
      if (window.pieces && window.pieces.gsap) {
        window.gsap = window.pieces.gsap;
      } else {
        setTimeout(initUnrevealEffects, 100);
        return;
      }
    }

    const effectType = wrapper.dataset.effect || 'rotated';
    const contentItems = wrapper.querySelectorAll('[data-cc2-item]');
    const overlay = wrapper.querySelector('[data-cc2-overlay]');
    const preview = wrapper.querySelector('[data-cc2-preview]');

    let current = -1;
    let isAnimating = false;
    let originalUrl = window.location.href;
    const productCache = new Map();

    // Remove loading state
    wrapper.classList.remove('is-loading');

    // Get window size for circle effect
    const getWinSize = () => ({
      width: window.innerWidth,
      height: window.innerHeight
    });

    // Fetch product section via Sections Rendering API
    async function fetchProductSection(productUrl) {
      if (productCache.has(productUrl)) {
        return productCache.get(productUrl);
      }

      try {
        const response = await fetch(`${productUrl}?sections=product`);
        if (!response.ok) throw new Error('Failed to fetch product section');

        const data = await response.json();
        const html = data.product || data['main-product'] || Object.values(data)[0];

        productCache.set(productUrl, html);
        return html;
      } catch (error) {
        console.error('Error fetching product section:', error);
        return null;
      }
    }

    // Preload product section on hover
    function preloadProduct(productUrl) {
      if (!productCache.has(productUrl)) {
        fetchProductSection(productUrl);
      }
    }

    // Hover effects
    contentItems.forEach((item) => {
      const imgWrap = item.querySelector('.cc2-content__item-imgwrap');
      const img = item.querySelector('.cc2-content__item-img');
      const titleInners = item.querySelectorAll('.cc2-content__item-title .cc2-oh__inner');
      const productUrl = item.dataset.productUrl;

      item.addEventListener('mouseenter', () => {
        if (isAnimating) return;

        // Preload on hover
        if (productUrl) preloadProduct(productUrl);

        gsap.to(imgWrap, {
          scale: 0.95,
          duration: 0.4,
          ease: 'power2.out'
        });

        gsap.to(img, {
          scale: 1.15,
          duration: 0.4,
          ease: 'power2.out'
        });

        gsap.to(titleInners, {
          yPercent: -10,
          rotation: -2,
          filter: 'blur(2px)',
          stagger: 0.02,
          duration: 0.3,
          ease: 'power2.out'
        });
      });

      item.addEventListener('mouseleave', () => {
        if (isAnimating) return;

        gsap.to(imgWrap, {
          scale: 1,
          duration: 0.4,
          ease: 'power2.out'
        });

        gsap.to(img, {
          scale: 1,
          duration: 0.4,
          ease: 'power2.out'
        });

        gsap.to(titleInners, {
          yPercent: 0,
          rotation: 0,
          filter: 'blur(0px)',
          stagger: 0.02,
          duration: 0.3,
          ease: 'power2.out'
        });
      });
    });

    // Open preview - fetch product section and animate
    async function openPreview(index) {
      if (isAnimating || current === index) return;
      isAnimating = true;
      current = index;

      const contentItem = contentItems[index];
      const productUrl = contentItem.dataset.productUrl;
      const winSize = getWinSize();

      // Scroll to top smoothly
      window.scrollTo({ top: 0, behavior: 'smooth' });

      // Start fetching product section (should be cached from hover)
      const productHtmlPromise = fetchProductSection(productUrl);

      // Start overlay animation
      const tl = gsap.timeline();
      tl.addLabel('start', 0);

      if (effectType === 'rotated') {
        tl.to(overlay, {
          x: '100%',
          rotation: 0,
          duration: 1.1,
          ease: 'expo.inOut'
        }, 'start');
      } else if (effectType === 'circle') {
        tl.to(overlay, {
          clipPath: `circle(75vmax at ${winSize.width/2}px ${winSize.height/2}px)`,
          duration: 1.1,
          ease: 'expo.inOut'
        }, 'start');
      } else if (effectType === 'strip') {
        tl.to(overlay, {
          y: '0%',
          duration: 0.9,
          ease: 'expo.inOut'
        }, 'start');
      }

      // Wait for product HTML and overlay animation to complete
      const [productHtml] = await Promise.all([
        productHtmlPromise,
        new Promise(resolve => tl.add(resolve, 0.6))
      ]);

      if (productHtml) {
        // Inject product section HTML into preview container
        preview.innerHTML = productHtml;
        wrapper.classList.add('is-preview-open');

        // Find elements to animate in the fetched product section
        const productSection = preview.querySelector('section, .shopify-section');
        const productImages = preview.querySelectorAll('.product-intro__image, .aspect-square, [class*="aspect-"]');
        const productTitle = preview.querySelector('.product-intro__title, h1');
        const productPrice = preview.querySelector('.product-intro__price, #product-price');
        const productDescription = preview.querySelector('.product-intro__description, .prose');
        const productForm = preview.querySelector('.product-intro__form, form');

        // Set initial states for product content
        if (productSection) gsap.set(productSection, { opacity: 1 });
        if (productImages.length) gsap.set(productImages, { clipPath: 'inset(0 100% 0 0)', scale: 1.1 });
        if (productTitle) gsap.set(productTitle, { y: 40, opacity: 0 });
        if (productPrice) gsap.set(productPrice, { y: 30, opacity: 0 });
        if (productDescription) gsap.set(productDescription, { y: 30, opacity: 0 });
        if (productForm) gsap.set(productForm, { y: 30, opacity: 0 });

        // Animate product content in
        const contentTl = gsap.timeline();

        if (productImages.length) {
          contentTl.to(productImages, {
            clipPath: 'inset(0 0% 0 0)',
            scale: 1,
            duration: 1,
            ease: 'expo.out',
            stagger: 0.1
          }, 0);
        }

        if (productTitle) {
          contentTl.to(productTitle, {
            y: 0,
            opacity: 1,
            duration: 0.8,
            ease: 'expo.out'
          }, 0.2);
        }

        if (productPrice) {
          contentTl.to(productPrice, {
            y: 0,
            opacity: 1,
            duration: 0.6,
            ease: 'power2.out'
          }, 0.3);
        }

        if (productDescription) {
          contentTl.to(productDescription, {
            y: 0,
            opacity: 1,
            duration: 0.6,
            ease: 'power2.out'
          }, 0.4);
        }

        if (productForm) {
          contentTl.to(productForm, {
            y: 0,
            opacity: 1,
            duration: 0.6,
            ease: 'power2.out'
          }, 0.5);
        }

        // Re-init Shopify features
        if (window.Shopify && window.Shopify.PaymentButton) {
          window.Shopify.PaymentButton.init();
        }

        // Update URL
        contentTl.add(() => {
          isAnimating = false;
          if (productUrl) {
            window.history.pushState({ cc2Preview: true, index: index }, '', productUrl);
          }
        });
      } else {
        // Fallback if fetch failed
        isAnimating = false;
      }
    }

    // Close preview and return to collection
    function closePreview() {
      if (isAnimating || current === -1) return;
      isAnimating = true;

      const winSize = getWinSize();

      // Find elements in preview to animate out
      const productImages = preview.querySelectorAll('.product-intro__image, .aspect-square, [class*="aspect-"]');
      const productTitle = preview.querySelector('.product-intro__title, h1');
      const productPrice = preview.querySelector('.product-intro__price, #product-price');
      const productDescription = preview.querySelector('.product-intro__description, .prose');
      const productForm = preview.querySelector('.product-intro__form, form');

      const tl = gsap.timeline();

      // Animate content out
      if (productForm) {
        tl.to(productForm, { y: -20, opacity: 0, duration: 0.3, ease: 'power2.in' }, 0);
      }
      if (productDescription) {
        tl.to(productDescription, { y: -20, opacity: 0, duration: 0.3, ease: 'power2.in' }, 0.05);
      }
      if (productPrice) {
        tl.to(productPrice, { y: -30, opacity: 0, duration: 0.3, ease: 'power2.in' }, 0.1);
      }
      if (productTitle) {
        tl.to(productTitle, { y: -40, opacity: 0, duration: 0.4, ease: 'power3.in' }, 0.15);
      }
      if (productImages.length) {
        tl.to(productImages, { clipPath: 'inset(0 100% 0 0)', scale: 1.1, duration: 0.6, ease: 'power2.in', stagger: 0.05 }, 0.2);
      }

      // Reverse overlay animation
      tl.addLabel('overlay', 0.4);

      if (effectType === 'rotated') {
        tl.to(overlay, {
          x: '-100%',
          rotation: 5,
          duration: 1.1,
          ease: 'expo.inOut'
        }, 'overlay');
      } else if (effectType === 'circle') {
        tl.to(overlay, {
          clipPath: 'circle(0vmax at 50% 50%)',
          duration: 1.1,
          ease: 'expo.inOut'
        }, 'overlay');
      } else if (effectType === 'strip') {
        tl.to(overlay, {
          y: '100%',
          duration: 0.9,
          ease: 'expo.inOut'
        }, 'overlay');
      }

      tl.add(() => {
        // Reset states
        wrapper.classList.remove('is-preview-open');
        preview.innerHTML = '';
        current = -1;
        isAnimating = false;

        // Reset overlay to initial position
        if (effectType === 'rotated') {
          gsap.set(overlay, { x: '-100%', rotation: 5 });
        } else if (effectType === 'circle') {
          gsap.set(overlay, { clipPath: 'circle(0vmax at 50% 50%)' });
        } else if (effectType === 'strip') {
          gsap.set(overlay, { y: '100%' });
        }

        // Restore original URL
        window.history.replaceState({}, '', originalUrl);
      });
    }

    // Event listeners
    contentItems.forEach((item, index) => {
      item.addEventListener('click', () => openPreview(index));
    });

    // Handle browser back button - close preview instead of navigating
    function handlePopState(e) {
      if (current !== -1 && !isAnimating) {
        e.preventDefault();
        closePreview();
      }
    }
    window.addEventListener('popstate', handlePopState);

    // Close on escape key
    document.addEventListener('keydown', (e) => {
      if (e.key === 'Escape' && current !== -1 && !isAnimating) {
        closePreview();
      }
    });

    // Cleanup on Swup navigation
    window.addEventListener('swup:contentReplaced', () => {
      window.removeEventListener('popstate', handlePopState);
      if (current !== -1) {
        current = -1;
        isAnimating = false;
      }
    });
  }

  // Initialize
  if (document.readyState === 'loading') {
    document.addEventListener('DOMContentLoaded', initUnrevealEffects);
  } else {
    initUnrevealEffects();
  }
})();
</script>

{% schema %}
{
  "name": "Creative Collection 2",
  "tag": "section",
  "settings": [
    {
      "type": "collection",
      "id": "collection",
      "label": "Collection"
    },
    {
      "type": "range",
      "id": "products_to_show",
      "min": 2,
      "max": 12,
      "step": 1,
      "default": 6,
      "label": "Products to show"
    },
    {
      "type": "select",
      "id": "effect_type",
      "label": "Transition Effect",
      "options": [
        {
          "value": "rotated",
          "label": "Rotated"
        },
        {
          "value": "circle",
          "label": "Circle"
        },
        {
          "value": "strip",
          "label": "Strip"
        }
      ],
      "default": "rotated"
    }
  ],
  "presets": [
    {
      "name": "Creative Collection 2",
      "category": "Collection"
    }
  ]
}
{% endschema %}
