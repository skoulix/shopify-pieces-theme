{%- comment -%}
  Product Section - Minimal Skeleton + Tailwind UI Design
  With intro animations matching creative-collection-2 preview transitions
{%- endcomment -%}

{% assign current_variant = product.selected_or_first_available_variant %}

<style>
  /* Product intro animation initial states */
  .product-intro .product-intro__image {
    clip-path: inset(0 100% 0 0);
    transform: scale(1.1);
  }

  .product-intro .product-intro__title,
  .product-intro .product-intro__price,
  .product-intro .product-intro__description,
  .product-intro .product-intro__form {
    opacity: 0;
    transform: translateY(30px);
  }

  /* Animated states */
  .product-intro--animated .product-intro__image {
    clip-path: inset(0 0% 0 0);
    transform: scale(1);
  }

  .product-intro--animated .product-intro__title,
  .product-intro--animated .product-intro__price,
  .product-intro--animated .product-intro__description,
  .product-intro--animated .product-intro__form {
    opacity: 1;
    transform: translateY(0);
  }
</style>

<section class="bg-white product-intro" data-product-intro>
  <div class="mx-auto max-w-7xl px-4 py-16 sm:px-6 sm:py-24 lg:px-8">
    <div class="lg:grid lg:grid-cols-2 lg:items-start lg:gap-x-12">

      {%- comment -%} Product Images {%- endcomment -%}
      <div class="space-y-4">
        {% for image in product.images %}
          <div class="aspect-square w-full overflow-hidden rounded-lg bg-gray-100 product-intro__image">
            {{ image | image_url: width: 1200 | image_tag:
              class: 'h-full w-full object-cover object-center',
              loading: forloop.first | default: 'lazy'
            }}
          </div>
        {% else %}
          <div class="aspect-square w-full overflow-hidden rounded-lg bg-gray-100 product-intro__image">
            <div class="flex h-full items-center justify-center">
              <i class="ph ph-image text-6xl text-gray-300"></i>
            </div>
          </div>
        {% endfor %}
      </div>

      {%- comment -%} Product Info {%- endcomment -%}
      <div class="mt-10 px-4 sm:mt-16 sm:px-0 lg:sticky lg:top-24 lg:mt-0">
        <h1 class="text-3xl font-bold tracking-tight text-gray-900 product-intro__title">{{ product.title }}</h1>

        {%- comment -%} Price {%- endcomment -%}
        <div class="mt-3 product-intro__price" id="product-price">
          <p class="text-3xl tracking-tight text-gray-900" data-product-price>{{ current_variant.price | money }}</p>
          {% if current_variant.compare_at_price > current_variant.price %}
            <p class="mt-1 text-sm text-gray-500 line-through" data-compare-price>{{ current_variant.compare_at_price | money }}</p>
          {% endif %}
        </div>

        {%- comment -%} Description {%- endcomment -%}
        <div class="mt-6 product-intro__description">
          <div class="prose prose-sm text-gray-600">
            {{ product.description }}
          </div>
        </div>

        {%- comment -%} Product Form {%- endcomment -%}
        <div class="mt-8 product-intro__form">
          {% form 'product', product %}
            {%- comment -%} Variant Selector {%- endcomment -%}
            <div class="mb-6">
              <label for="variant-select" class="block text-sm font-medium text-gray-700">Options</label>
              <select
                id="variant-select"
                name="id"
                class="mt-2 block w-full rounded-md border-0 py-3 pl-3 pr-10 text-gray-900 ring-1 ring-inset ring-gray-300 focus:ring-2 focus:ring-indigo-600 sm:text-sm"
              >
                {% for variant in product.variants %}
                  <option
                    value="{{ variant.id }}"
                    {% if variant == current_variant %}selected{% endif %}
                  >
                    {{ variant.title }} - {{ variant.price | money }}
                  </option>
                {% endfor %}
              </select>
            </div>

            {%- comment -%} Quantity {%- endcomment -%}
            <div class="mb-6">
              <label for="quantity" class="block text-sm font-medium text-gray-700">Quantity</label>
              <input
                type="number"
                id="quantity"
                name="quantity"
                value="1"
                min="1"
                class="mt-2 block w-20 rounded-md border-0 py-2 px-3 text-gray-900 ring-1 ring-inset ring-gray-300 focus:ring-2 focus:ring-indigo-600 sm:text-sm"
              >
            </div>

            {%- comment -%} Add to Cart Button {%- endcomment -%}
            <button
              type="submit"
              data-add-to-cart
              class="flex w-full items-center justify-center rounded-md border border-transparent bg-indigo-600 px-8 py-3 text-base font-medium text-white hover:bg-indigo-700 focus:outline-none focus:ring-2 focus:ring-indigo-500 focus:ring-offset-2 disabled:bg-gray-300 disabled:cursor-not-allowed"
              {% unless current_variant.available %}disabled{% endunless %}
            >
              {% if current_variant.available %}
                <i class="ph ph-bag mr-2"></i>Add to cart
              {% else %}
                Sold out
              {% endif %}
            </button>

            {%- comment -%} Dynamic Checkout {%- endcomment -%}
            <div class="mt-4 [&_.shopify-payment-button__button]:rounded-md [&_.shopify-payment-button__button]:py-3">
              {{ form | payment_button }}
            </div>
          {% endform %}
        </div>
      </div>

    </div>
  </div>
</section>

<script>
  (function() {
    const variants = {{ product.variants | json }};
    const moneyFormat = {{ shop.money_format | json }};
    const select = document.getElementById('variant-select');
    const priceEl = document.querySelector('[data-product-price]');
    const compareEl = document.querySelector('[data-compare-price]');
    const addButton = document.querySelector('[data-add-to-cart]');

    function formatMoney(cents) {
      const amount = (cents / 100).toFixed(2);
      return moneyFormat.replace(/\{\{\s*amount\s*\}\}/, amount)
                        .replace(/\{\{\s*amount_no_decimals\s*\}\}/, Math.round(cents / 100))
                        .replace(/\{\{\s*amount_with_comma_separator\s*\}\}/, amount.replace('.', ','));
    }

    if (!select) return;

    select.addEventListener('change', function() {
      const variant = variants.find(v => v.id === parseInt(this.value));
      if (!variant) return;

      // Update price
      if (priceEl) {
        priceEl.textContent = formatMoney(variant.price);
      }

      // Update compare price
      if (compareEl) {
        if (variant.compare_at_price && variant.compare_at_price > variant.price) {
          compareEl.textContent = formatMoney(variant.compare_at_price);
          compareEl.style.display = '';
        } else {
          compareEl.style.display = 'none';
        }
      }

      // Update button state
      if (addButton) {
        if (variant.available) {
          addButton.disabled = false;
          addButton.innerHTML = '<i class="ph ph-bag mr-2"></i>Add to cart';
        } else {
          addButton.disabled = true;
          addButton.textContent = 'Sold out';
        }
      }

      // Update URL with variant
      const url = new URL(window.location);
      url.searchParams.set('variant', variant.id);
      window.history.replaceState({}, '', url);
    });
  })();
</script>

<script>
  /**
   * Product Intro Animation
   * Matches the creative-collection-2 preview transitions for consistency
   * Only runs on direct page load (not when loaded via Sections API in cc2 preview)
   */
  (function() {
    const section = document.querySelector('[data-product-intro]');
    if (!section) return;
    if (section.dataset.introInitialized) return;

    // Skip animation if we're inside the cc2-preview container
    // (cc2 handles its own animations for fetched content)
    if (section.closest('.cc2-preview')) {
      section.classList.add('product-intro--animated');
      return;
    }

    section.dataset.introInitialized = 'true';

    function runIntroAnimation() {
      // Check for GSAP
      let gsap = window.gsap;
      if (!gsap && window.pieces && window.pieces.gsap) {
        gsap = window.pieces.gsap;
      }

      if (!gsap) {
        // Fallback: just add animated class immediately
        section.classList.add('product-intro--animated');
        return;
      }

      const images = section.querySelectorAll('.product-intro__image');
      const title = section.querySelector('.product-intro__title');
      const price = section.querySelector('.product-intro__price');
      const description = section.querySelector('.product-intro__description');
      const form = section.querySelector('.product-intro__form');

      // Create timeline matching creative-collection-2 preview animations
      const tl = gsap.timeline({
        onComplete: () => section.classList.add('product-intro--animated')
      });

      // Small delay to ensure page is ready
      tl.addLabel('start', 0.1);

      // Animate images with clip-path reveal (same as preview)
      if (images.length) {
        tl.to(images, {
          clipPath: 'inset(0 0% 0 0)',
          scale: 1,
          duration: 1,
          ease: 'expo.out',
          stagger: 0.1
        }, 'start');
      }

      // Animate title
      if (title) {
        tl.to(title, {
          y: 0,
          opacity: 1,
          duration: 0.8,
          ease: 'expo.out'
        }, 'start+=0.2');
      }

      // Animate price
      if (price) {
        tl.to(price, {
          y: 0,
          opacity: 1,
          duration: 0.6,
          ease: 'power2.out'
        }, 'start+=0.3');
      }

      // Animate description
      if (description) {
        tl.to(description, {
          y: 0,
          opacity: 1,
          duration: 0.6,
          ease: 'power2.out'
        }, 'start+=0.4');
      }

      // Animate form
      if (form) {
        tl.to(form, {
          y: 0,
          opacity: 1,
          duration: 0.6,
          ease: 'power2.out'
        }, 'start+=0.5');
      }
    }

    // Run animation after page load
    if (document.readyState === 'complete') {
      runIntroAnimation();
    } else {
      window.addEventListener('load', runIntroAnimation);
    }

    // Also run on Swup content replace (for SPA navigation)
    window.addEventListener('swup:contentReplaced', () => {
      // Reset and re-run animation for new content
      const newSection = document.querySelector('[data-product-intro]');
      if (newSection && !newSection.dataset.introInitialized && !newSection.closest('.cc2-preview')) {
        newSection.dataset.introInitialized = 'true';
        runIntroAnimation();
      }
    });
  })();
</script>

{% schema %}
{
  "name": "Product",
  "settings": [],
  "disabled_on": {
    "groups": ["header", "footer"]
  }
}
{% endschema %}
