{%- comment -%}
  Shoppable Videos - Video carousel with product integration
  Features: Keen Slider carousel, video lightbox, product overlays, add-to-cart
{%- endcomment -%}

{%- liquid
  if section.settings.full_width
    assign container_class = 'page-full'
  else
    assign container_class = 'page-container'
  endif

  assign videos_mobile = section.settings.videos_mobile | default: '1'
  assign videos_tablet = section.settings.videos_tablet | default: '3'
  assign videos_desktop = section.settings.videos_desktop | default: '4'
  assign video_spacing = section.settings.video_spacing | default: 'medium'
  assign video_aspect_ratio = section.settings.video_aspect_ratio | default: '9/16'

  # Global card settings
  assign card_radius = settings.card_radius | default: 8
  assign card_border_width = settings.card_border_width | default: 0
  assign card_shadow = settings.card_shadow | default: 'none'
-%}

<!-- Keen Slider CSS -->
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/keen-slider@6.8.6/keen-slider.min.css">

<style>
  .shoppable-videos-{{ section.id }} {
    background-color: {{ section.settings.background_color }};
    color: {{ section.settings.text_color }};
    padding: var(--section-vertical-padding) 0;
    overflow: hidden;
  }

  /* Header - matching testimonials */
  .shoppable-videos-header-{{ section.id }} {
    margin-bottom: clamp(3rem, 6vh, 5rem);
    text-align: {{ section.settings.header_alignment }};
  }

  .shoppable-videos-label-{{ section.id }} {
    display: inline-block;
    font-size: 0.65rem;
    font-weight: 600;
    text-transform: uppercase;
    letter-spacing: 0.2em;
    margin-bottom: 1.5rem;
  }

  .shoppable-videos-label-{{ section.id }}.intro-visible {
    opacity: 0.5;
  }

  .shoppable-videos-title-{{ section.id }} {
    font-size: calc(clamp(2rem, 5vw, 3.5rem) * var(--heading-font-scale, 1));
    font-weight: 700;
    letter-spacing: -0.03em;
    line-height: 1;
  }

  .shoppable-videos-title-line:nth-child(2) {
    margin-left: clamp(0.5rem, 4vw, 2rem);
  }

  .shoppable-videos-description-{{ section.id }} {
    font-size: 1rem;
    opacity: 0.7;
    max-width: 42rem;
    margin-top: 1.5rem;
    {% if section.settings.header_alignment == 'center' %}
    margin-left: auto;
    margin-right: auto;
    {% endif %}
  }

  /* Video card styles */
  .shoppable-video-card-{{ section.id }} {
    position: relative;
    overflow: hidden;
    isolation: isolate;
    display: block;
    aspect-ratio: {{ video_aspect_ratio }};
    width: 100%;
    height: auto;
    border-radius: {{ card_radius }}px;
    {% if card_border_width > 0 %}
    border: {{ card_border_width }}px solid var(--color-border);
    {% endif %}
    {% case card_shadow %}
      {% when 'sm' %}
      box-shadow: 0 1px 2px 0 rgba(0, 0, 0, 0.05);
      {% when 'md' %}
      box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -2px rgba(0, 0, 0, 0.1);
      {% when 'lg' %}
      box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -4px rgba(0, 0, 0, 0.1);
      {% when 'hard' %}
      box-shadow: 4px 4px 0 0 {{ section.settings.text_color }}15;
    {% endcase %}
  }

  .shoppable-videos-{{ section.id }} .keen-slider__slide {
    height: auto !important;
    min-height: 0 !important;
  }

  .shoppable-videos-{{ section.id }} .video-slide {
    width: 100%;
    height: auto !important;
  }

  .shoppable-video-slide-inner {
    width: 100%;
    height: 100%;
  }

  /* Play overlay */
  .shoppable-video-card-{{ section.id }}.cursor-pointer .play-overlay {
    opacity: 0;
    transition: opacity 0.3s ease;
  }

  .shoppable-video-card-{{ section.id }}.cursor-pointer:hover .play-overlay {
    opacity: 1;
  }

  .shoppable-video-card-{{ section.id }}.cursor-default {
    cursor: default !important;
  }

  /* Navigation - matching testimonials style */
  .shoppable-videos-nav-{{ section.id }} {
    display: flex;
    align-items: center;
    justify-content: center;
    gap: 1rem;
    margin-top: 3rem;
  }

  .shoppable-videos-nav-btn-{{ section.id }} {
    width: 48px;
    height: 48px;
    border-radius: 50%;
    background: transparent;
    border: 1px solid {{ section.settings.text_color }}30;
    color: {{ section.settings.text_color }};
    display: flex;
    align-items: center;
    justify-content: center;
    cursor: pointer;
    transition: all 0.3s ease;
  }

  .shoppable-videos-nav-btn-{{ section.id }}:hover {
    background: {{ section.settings.text_color }};
    color: {{ section.settings.background_color }};
  }

  .shoppable-videos-nav-btn-{{ section.id }}:disabled {
    opacity: 0.3;
    cursor: not-allowed;
  }

  .shoppable-videos-nav-btn-{{ section.id }}:disabled:hover {
    background: transparent;
    color: {{ section.settings.text_color }};
  }

  /* Lightbox styles */
  .shoppable-video-lightbox {
    position: fixed;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    background: rgba(0, 0, 0, 0.95);
    z-index: 9999;
    display: none;
    align-items: center;
    justify-content: center;
  }

  .shoppable-video-lightbox.active {
    display: flex;
  }

  .shoppable-lightbox-content {
    display: flex;
    gap: 2rem;
    max-width: 1400px;
    width: 90%;
    max-height: 85vh;
  }

  .shoppable-lightbox-video {
    flex: 1;
    position: relative;
    display: flex;
    align-items: center;
    justify-content: center;
  }

  .shoppable-lightbox-video video {
    width: 100%;
    height: auto;
    max-height: 75vh;
    max-width: 100%;
    object-fit: contain;
    transition: opacity 0.3s ease;
    border-radius: {{ card_radius }}px;
  }

  .shoppable-lightbox-product {
    width: 320px;
    background: white;
    padding: 1.5rem;
    border-radius: {{ card_radius }}px;
    overflow-y: auto;
    max-height: 75vh;
    flex-shrink: 0;
  }

  #shoppable-product-info-{{ section.id }} {
    transition: opacity 0.3s ease;
  }

  .shoppable-lightbox-close {
    position: absolute;
    top: 20px;
    right: 20px;
    width: 48px;
    height: 48px;
    background: rgba(255, 255, 255, 0.1);
    border: 1px solid rgba(255, 255, 255, 0.3);
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    cursor: pointer;
    transition: all 0.3s ease;
    z-index: 10000;
    color: white;
  }

  .shoppable-lightbox-close:hover {
    background: white;
    color: black;
  }

  /* Lightbox navigation buttons */
  .shoppable-lightbox-nav {
    position: absolute;
    top: 50%;
    transform: translateY(-50%);
    z-index: 10000;
    width: 48px;
    height: 48px;
    border-radius: 50%;
    background: rgba(255, 255, 255, 0.1);
    border: 1px solid rgba(255, 255, 255, 0.3);
    display: flex;
    align-items: center;
    justify-content: center;
    cursor: pointer;
    transition: all 0.3s ease;
    color: white;
  }

  .shoppable-lightbox-nav:hover {
    background: white;
    color: black;
  }

  .shoppable-lightbox-nav.lightbox-prev { left: 2rem; }
  .shoppable-lightbox-nav.lightbox-next { right: 2rem; }
  .shoppable-lightbox-nav:disabled { opacity: 0.3; cursor: not-allowed; }
  .shoppable-lightbox-nav:disabled:hover { background: rgba(255, 255, 255, 0.1); color: white; transform: translateY(-50%); }

  /* Mobile responsive lightbox */
  @media (max-width: 768px) {
    .shoppable-lightbox-nav {
      width: 40px;
      height: 40px;
      top: auto;
      transform: none;
    }
    .shoppable-lightbox-nav.lightbox-prev { top: 20px; left: 20px; }
    .shoppable-lightbox-nav.lightbox-next { top: 20px; left: 70px; }
    .shoppable-lightbox-nav:hover { transform: none; }
    .shoppable-lightbox-nav:disabled:hover { transform: none; }

    .shoppable-lightbox-content {
      flex-direction: column;
      width: calc(100% - 1rem);
      max-width: calc(100% - 1rem);
      max-height: calc(100vh - 1rem);
      gap: 0;
      margin: 0.5rem;
    }

    .shoppable-lightbox-video {
      width: 100%;
      flex: 1;
      min-height: 0;
    }

    .shoppable-lightbox-video video {
      border-radius: {{ card_radius }}px {{ card_radius }}px 0 0 !important;
      max-height: 60vh;
      width: 100%;
    }

    .shoppable-lightbox-product {
      width: 100%;
      max-height: 35vh;
      border-radius: 0 0 {{ card_radius }}px {{ card_radius }}px;
      padding: 1rem;
    }
  }

  /* Keen Slider customization */
  .shoppable-videos-{{ section.id }} .keen-slider {
    display: flex;
    overflow: hidden;
    position: relative;
    user-select: none;
    touch-action: pan-y;
  }

  .shoppable-videos-{{ section.id }} .keen-slider__slide {
    position: relative;
    overflow: visible;
    width: 100%;
    height: max-content !important;
    min-height: unset !important;
    flex-shrink: 0;
  }

  /* Animation states */
  html.animations-disabled .shoppable-videos-{{ section.id }} [data-intro] {
    opacity: 1;
    transform: none;
  }

  html.animations-disabled .shoppable-videos-title-{{ section.id }} {
    opacity: 1;
    transform: none;
  }

  html.animations-disabled .shoppable-videos-label-{{ section.id }} {
    opacity: 0.5;
    transform: none;
  }
</style>

<section
  class="shoppable-videos-{{ section.id }}"
  data-shoppable-videos="{{ section.id }}"
>
  <div class="{{ container_class }}">
    {%- comment -%} Header {%- endcomment -%}
    {% if section.settings.label != blank or section.settings.title != blank or section.settings.description != blank %}
      <div class="shoppable-videos-header-{{ section.id }}">
        {% if section.settings.label != blank %}
          <span class="shoppable-videos-label-{{ section.id }}" data-intro>
            {{ section.settings.label }}
          </span>
        {% endif %}

        {% if section.settings.title != blank %}
          <h2 class="shoppable-videos-title-{{ section.id }} font-heading" data-shoppable-videos-title>
            {{ section.settings.title }}
          </h2>
        {% endif %}

        {% if section.settings.description != blank %}
          <p class="shoppable-videos-description-{{ section.id }}">
            {{ section.settings.description }}
          </p>
        {% endif %}
      </div>
    {% endif %}

    <!-- Videos Carousel -->
    <div class="relative w-full">
      <div id="shoppable-videos-slider-{{ section.id }}" class="keen-slider">
        {% for block in section.blocks %}
          {% if block.type == 'video' %}
            {%- liquid
              assign video_hosted = block.settings.video_hosted
              assign video_external = block.settings.video_url
              assign product = block.settings.product
              assign has_video = false

              if video_hosted != blank
                assign has_video = true
                assign video_type = 'hosted'
              elsif video_external != blank
                assign has_video = true
                assign video_type = 'external'
              endif

              case video_spacing
                when 'none'
                  assign spacing_px = 0
                when 'small'
                  assign spacing_px = 8
                when 'large'
                  assign spacing_px = 24
                else
                  assign spacing_px = 16
              endcase
            -%}
            <div class="keen-slider__slide video-slide" data-index="{{ forloop.index0 }}" {{ block.shopify_attributes }}>
              <div class="shoppable-video-slide-inner" {% unless video_spacing == 'none' %}style="padding-right: {{ spacing_px }}px;"{% endunless %}>
                <div class="shoppable-video-card-{{ section.id }} relative w-full overflow-hidden {% if has_video %}cursor-pointer{% else %}cursor-default{% endif %}"
                     style="background-color: {{ section.settings.text_color }}08;"
                     {% if video_type == 'hosted' %}
                       data-video-url="{{ video_hosted.sources[1].url | default: video_hosted.sources[0].url }}"
                     {% elsif video_type == 'external' %}
                       data-video-url="{{ video_external }}"
                       data-video-type="{{ video_external.type }}"
                     {% endif %}
                     {% if product != blank %}
                       data-product-id="{{ product.id }}"
                       data-product-title="{{ product.title | escape }}"
                       data-product-price="{{ product.price }}"
                       data-product-handle="{{ product.handle }}"
                       data-variant-id="{{ product.selected_or_first_available_variant.id }}"
                       {% if product.compare_at_price > product.price %}
                         data-product-compare-price="{{ product.compare_at_price }}"
                       {% endif %}
                       data-product-image="{{ product.featured_image | image_url: width: 400 }}"
                     {% endif %}
                     data-video-index="{{ forloop.index0 }}"
                     {% if block.settings.alt_text != blank %}aria-label="{{ block.settings.alt_text }}"{% endif %}>

                  {% if video_type == 'hosted' %}
                    <video
                      class="carousel-video absolute inset-0 z-0 w-full h-full object-cover block pointer-events-none"
                      style="border-radius: {{ card_radius }}px;"
                      autoplay
                      muted
                      loop
                      playsinline
                      preload="metadata"
                      {% if block.settings.alt_text != blank %}aria-label="{{ block.settings.alt_text }}"{% endif %}>
                      {%- for source in video_hosted.sources -%}
                        <source src="{{ source.url }}" type="{{ source.mime_type }}">
                      {%- endfor -%}
                    </video>
                  {% elsif video_type == 'external' %}
                    {%- comment -%} Show video preview image for YouTube/Vimeo {%- endcomment -%}
                    <div class="absolute inset-0 w-full h-full flex items-center justify-center z-0" style="background: {{ section.settings.text_color }}08;">
                      {% if video_external.type == 'youtube' %}
                        <img
                          src="https://img.youtube.com/vi/{{ video_external.id }}/hqdefault.jpg"
                          alt="{{ block.settings.alt_text | default: 'Video thumbnail' }}"
                          class="absolute inset-0 w-full h-full object-cover"
                          style="border-radius: {{ card_radius }}px;"
                          loading="lazy"
                        >
                      {% else %}
                        <i class="ph ph-play-circle text-6xl" style="color: {{ section.settings.text_color }}40;"></i>
                      {% endif %}
                    </div>
                  {% else %}
                    <div class="absolute inset-0 w-full h-full flex items-center justify-center z-0" style="background: {{ section.settings.text_color }}08;">
                      <i class="ph ph-video-camera text-6xl" style="color: {{ section.settings.text_color }}20;"></i>
                    </div>
                  {% endif %}

                  {%- comment -%} Gradient overlay for readability {%- endcomment -%}
                  {% if has_video %}
                    <div class="absolute inset-0 z-[1] pointer-events-none" style="background: linear-gradient(to bottom, transparent 0%, transparent 50%, rgba(0,0,0,0.7) 100%); border-radius: {{ card_radius }}px;"></div>
                  {% endif %}

                  {% if has_video %}
                    <div class="play-overlay absolute inset-0 z-[2] flex items-center justify-center pointer-events-none">
                      <div class="bg-black/50 rounded-full p-4">
                        <i class="ph ph-{% if video_type == 'external' %}play{% else %}arrows-out{% endif %} text-4xl text-white"></i>
                      </div>
                    </div>
                  {% endif %}

                  {% if section.settings.show_product_info and product != blank %}
                    <div class="shoppable-product-info absolute inset-x-0 bottom-0 p-3 pointer-events-none" style="z-index: 20; border-radius: 0 0 {{ card_radius }}px {{ card_radius }}px;">
                      <h3 class="text-white text-sm font-semibold mb-1 line-clamp-2">{{ product.title }}</h3>
                      <div class="text-sm text-white mb-2">
                        {% if product.compare_at_price > product.price %}
                          <span class="text-white/70 line-through mr-1">{{ product.compare_at_price | money }}</span>
                        {% endif %}
                        <span class="text-white font-bold">{{ product.price | money }}</span>
                      </div>
                      <div class="text-xs text-white font-medium uppercase tracking-wider">{{ 'gift_card.shop_now' | t }} <i class="ph ph-arrow-right"></i></div>
                    </div>
                  {% endif %}

                </div>
              </div>
            </div>
          {% endif %}
        {% endfor %}
      </div>

      <!-- Navigation Buttons -->
      <div class="shoppable-videos-nav-{{ section.id }}">
        <button class="shoppable-videos-nav-btn-{{ section.id }} shoppable-videos-prev" aria-label="{{ 'accessibility.previous_slide' | t }}">
          <i class="ph ph-arrow-left"></i>
        </button>
        <button class="shoppable-videos-nav-btn-{{ section.id }} shoppable-videos-next" aria-label="{{ 'accessibility.next_slide' | t }}">
          <i class="ph ph-arrow-right"></i>
        </button>
      </div>
    </div>
  </div>
</section>

<!-- Keen Slider JavaScript -->
<script src="https://cdn.jsdelivr.net/npm/keen-slider@6.8.6/keen-slider.min.js"></script>

<!-- Video Lightbox -->
<div class="shoppable-video-lightbox" id="shoppable-video-lightbox-{{ section.id }}" role="dialog" aria-modal="true" aria-label="{{ 'accessibility.close' | t }}">
  <button class="shoppable-lightbox-close" aria-label="{{ 'accessibility.close' | t }}">
    <i class="ph ph-x text-xl"></i>
  </button>

  <button class="shoppable-lightbox-nav lightbox-prev" aria-label="{{ 'accessibility.previous_slide' | t }}">
    <i class="ph ph-arrow-left"></i>
  </button>
  <button class="shoppable-lightbox-nav lightbox-next" aria-label="{{ 'accessibility.next_slide' | t }}">
    <i class="ph ph-arrow-right"></i>
  </button>

  <div class="shoppable-lightbox-content">
    <div class="shoppable-lightbox-video">
      <video controls autoplay muted playsinline preload="none" id="shoppable-lightbox-video-{{ section.id }}" style="display: none;">
        <source src="" type="video/mp4">
      </video>
      <div id="shoppable-lightbox-iframe-{{ section.id }}" class="shoppable-lightbox-iframe" style="display: none; width: 100%; aspect-ratio: 9/16; border-radius: {{ card_radius }}px; overflow: hidden;"></div>
    </div>

    <div class="shoppable-lightbox-product">
      <div id="shoppable-product-info-{{ section.id }}"></div>
    </div>
  </div>
</div>

<script>
(function() {
  'use strict';

  const sectionId = '{{ section.id }}';

  function initTitleAnimation() {
    const section = document.querySelector('[data-shoppable-videos="' + sectionId + '"]');
    if (!section) return;

    let gsap = window.gsap;
    if (!gsap && window.pieces && window.pieces.gsap) {
      gsap = window.pieces.gsap;
    }

    let SplitText = window.SplitText;
    if (!SplitText && window.pieces && window.pieces.SplitText) {
      SplitText = window.pieces.SplitText;
    }

    const ScrollTrigger = window.ScrollTrigger || (window.pieces && window.pieces.ScrollTrigger);

    // Title animation
    const shouldAnimate = typeof window.shouldAnimate === 'function' ? window.shouldAnimate() : true;
    const title = section.querySelector('[data-shoppable-videos-title]');
    const label = section.querySelector('.shoppable-videos-label-' + sectionId);

    if (shouldAnimate && title && gsap && SplitText && ScrollTrigger) {
      const split = new SplitText(title, { type: 'lines', linesClass: 'shoppable-videos-title-line' });

      split.lines.forEach(line => {
        const lineWrapper = document.createElement('div');
        lineWrapper.style.overflow = 'hidden';
        lineWrapper.style.display = 'block';
        line.parentNode.insertBefore(lineWrapper, line);
        lineWrapper.appendChild(line);
      });

      gsap.set(split.lines, { yPercent: 120 });

      gsap.to(split.lines, {
        yPercent: 0,
        duration: 1.2,
        ease: 'power4.out',
        stagger: 0.1,
        scrollTrigger: {
          trigger: section,
          start: 'top 70%',
          once: true
        }
      });
    }

    // Label intro animation
    if (shouldAnimate && label && gsap && ScrollTrigger) {
      gsap.set(label, { opacity: 0, y: 20 });
      gsap.to(label, {
        opacity: 0.5,
        y: 0,
        duration: 0.8,
        ease: 'power2.out',
        scrollTrigger: {
          trigger: section,
          start: 'top 70%',
          once: true
        },
        onComplete: () => label.classList.add('intro-visible')
      });
    } else if (label) {
      label.classList.add('intro-visible');
    }
  }

  function initShoppableVideosSlider() {
    const section = document.querySelector('[data-shoppable-videos="' + sectionId + '"]');
    if (!section) return;

    if (section.dataset.initialized) return;
    section.dataset.initialized = 'true';

    // Initialize title animations
    initTitleAnimation();

    const sliderElement = document.getElementById('shoppable-videos-slider-' + sectionId);
    if (!sliderElement || !window.KeenSlider) return;

    const prevBtn = section.querySelector('.shoppable-videos-prev');
    const nextBtn = section.querySelector('.shoppable-videos-next');
    const lightbox = document.getElementById('shoppable-video-lightbox-' + sectionId);
    const lightboxVideo = document.getElementById('shoppable-lightbox-video-' + sectionId);
    const productInfo = document.getElementById('shoppable-product-info-' + sectionId);
    const closeBtn = lightbox ? lightbox.querySelector('.shoppable-lightbox-close') : null;

    const enableMarquee = {{ section.settings.enable_marquee | json }} === true;
    const marqueeSpeed = parseInt('{{ section.settings.marquee_speed | default: 20 }}') || 20;
    const pauseOnHover = {{ section.settings.pause_on_hover | default: true | json }};

    const getPerView = () => {
      const width = window.innerWidth;
      if (width < 768) return '{{ videos_mobile }}' === '2' ? 2 : 1.2;
      if (width < 1024) return parseInt('{{ videos_tablet }}') || 3;
      return parseInt('{{ videos_desktop }}') || 4;
    };

    const getSpacing = () => {
      const spacing = '{{ video_spacing }}';
      if (spacing === 'none') return 0;
      if (spacing === 'small') return 8;
      if (spacing === 'large') return 24;
      return 16;
    };

    let slider = null;
    let marqueeIsPaused = false;

    const marqueePlugin = (slider) => {
      if (!enableMarquee) return;

      const calculateSpeed = () => {
        const minDuration = 500;
        const maxDuration = 5000;
        return Math.round(maxDuration - (marqueeSpeed - 1) * ((maxDuration - minDuration) / 99));
      };

      const startAnimation = () => {
        if (marqueeIsPaused || !slider) return;
        slider.moveToIdx(slider.track.details.abs + 1, true, { duration: calculateSpeed(), easing: (t) => t });
      };

      const stopAnimation = () => { if (slider?.animator) slider.animator.stop(); };

      slider.on("created", () => setTimeout(startAnimation, 100));
      slider.on("animationEnded", () => { if (!marqueeIsPaused) startAnimation(); });
      slider.on("dragStarted", () => { marqueeIsPaused = true; stopAnimation(); });
      slider.on("dragEnded", () => { marqueeIsPaused = false; setTimeout(startAnimation, 500); });

      if (pauseOnHover) {
        slider.container.addEventListener("mouseenter", () => { marqueeIsPaused = true; stopAnimation(); });
        slider.container.addEventListener("mouseleave", () => { marqueeIsPaused = false; startAnimation(); });
      }
    };

    const shouldCenterOnMobile = () => window.innerWidth < 768 && '{{ videos_mobile }}' === '1';

    slider = new KeenSlider(sliderElement, {
      loop: true,
      mode: enableMarquee ? "free-snap" : "snap",
      slides: { perView: getPerView(), spacing: getSpacing(), origin: shouldCenterOnMobile() ? "center" : "auto" },
      drag: true,
      rubberband: !enableMarquee,
      selector: ".keen-slider__slide",
    }, enableMarquee ? [marqueePlugin] : []);

    if (prevBtn) prevBtn.addEventListener('click', () => { if (enableMarquee) { marqueeIsPaused = true; setTimeout(() => { marqueeIsPaused = false; }, 500); } slider.prev(); });
    if (nextBtn) nextBtn.addEventListener('click', () => { if (enableMarquee) { marqueeIsPaused = true; setTimeout(() => { marqueeIsPaused = false; }, 500); } slider.next(); });

    let resizeTimeout;
    window.addEventListener('resize', () => {
      clearTimeout(resizeTimeout);
      resizeTimeout = setTimeout(() => {
        if (slider) slider.update({ slides: { perView: getPerView(), spacing: getSpacing(), origin: shouldCenterOnMobile() ? "center" : "auto" } });
      }, 100);
    });

    // Video autoplay on visibility
    const videoObserver = new IntersectionObserver((entries) => {
      entries.forEach(entry => {
        const video = entry.target.querySelector('.carousel-video');
        if (!video) return;
        if (entry.isIntersecting) video.play().catch(() => { video.muted = true; video.play().catch(() => {}); });
        else video.pause();
      });
    }, { threshold: 0.5 });

    section.querySelectorAll('.video-slide').forEach(slide => videoObserver.observe(slide));

    // Lightbox functionality
    const videoThumbnails = section.querySelectorAll('.shoppable-video-card-{{ section.id }}');
    let currentVideoIndex = 0;
    const prevButton = lightbox?.querySelector('.lightbox-prev');
    const nextButton = lightbox?.querySelector('.lightbox-next');

    function updateNav() {
      if (prevButton) prevButton.disabled = currentVideoIndex <= 0;
      if (nextButton) nextButton.disabled = currentVideoIndex >= videoThumbnails.length - 1;
    }

    const iframeContainer = document.getElementById('shoppable-lightbox-iframe-' + sectionId);

    function openVideoAtIndex(index) {
      if (index < 0 || index >= videoThumbnails.length) return;
      currentVideoIndex = index;
      const thumbnail = videoThumbnails[index];
      const videoUrl = thumbnail.dataset.videoUrl;
      const videoType = thumbnail.dataset.videoType;
      if (!videoUrl) return;

      // Hide both containers first
      if (lightboxVideo) lightboxVideo.style.display = 'none';
      if (iframeContainer) iframeContainer.style.display = 'none';

      if (videoType === 'youtube' || videoType === 'vimeo') {
        // External video - use iframe
        let embedUrl = '';
        if (videoType === 'youtube') {
          // Extract video ID from YouTube URL
          const match = videoUrl.match(/(?:youtube\.com\/(?:[^\/]+\/.+\/|(?:v|e(?:mbed)?)\/|.*[?&]v=)|youtu\.be\/)([^"&?\/\s]{11})/);
          const videoId = match ? match[1] : videoUrl;
          embedUrl = `https://www.youtube.com/embed/${videoId}?autoplay=1&rel=0`;
        } else if (videoType === 'vimeo') {
          // Extract video ID from Vimeo URL
          const match = videoUrl.match(/vimeo\.com\/(?:video\/)?(\d+)/);
          const videoId = match ? match[1] : videoUrl;
          embedUrl = `https://player.vimeo.com/video/${videoId}?autoplay=1`;
        }

        if (iframeContainer && embedUrl) {
          iframeContainer.innerHTML = `<iframe src="${embedUrl}" style="width: 100%; height: 100%; border: none;" allow="autoplay; fullscreen; picture-in-picture" allowfullscreen></iframe>`;
          iframeContainer.style.display = 'block';
        }
      } else {
        // Hosted video - use native video element
        if (lightboxVideo) {
          lightboxVideo.src = videoUrl;
          lightboxVideo.style.display = 'block';
          lightboxVideo.load();
          lightboxVideo.play().catch(() => { lightboxVideo.muted = true; lightboxVideo.play().catch(() => {}); });
        }
      }

      const productId = thumbnail.dataset.productId;
      if (productId && thumbnail.dataset.productTitle && thumbnail.dataset.variantId) {
        displayProductInfo({
          id: productId,
          title: thumbnail.dataset.productTitle,
          price: thumbnail.dataset.productPrice,
          compare_at_price: thumbnail.dataset.productComparePrice,
          handle: thumbnail.dataset.productHandle,
          variantId: thumbnail.dataset.variantId,
          image: thumbnail.dataset.productImage
        });
      } else if (productInfo) {
        productInfo.innerHTML = '';
      }

      lightbox.classList.add('active');
      document.body.style.overflow = 'hidden';
      updateNav();
    }

    if (prevButton) prevButton.addEventListener('click', () => { if (currentVideoIndex > 0) openVideoAtIndex(currentVideoIndex - 1); });
    if (nextButton) nextButton.addEventListener('click', () => { if (currentVideoIndex < videoThumbnails.length - 1) openVideoAtIndex(currentVideoIndex + 1); });

    document.addEventListener('keydown', (e) => {
      if (!lightbox?.classList.contains('active')) return;
      if (e.key === 'ArrowLeft' && currentVideoIndex > 0) openVideoAtIndex(currentVideoIndex - 1);
      else if (e.key === 'ArrowRight' && currentVideoIndex < videoThumbnails.length - 1) openVideoAtIndex(currentVideoIndex + 1);
      else if (e.key === 'Escape') closeLightbox();
    });

    videoThumbnails.forEach((thumbnail, index) => {
      thumbnail.addEventListener('click', (e) => { e.preventDefault(); if (thumbnail.dataset.videoUrl) openVideoAtIndex(index); });
    });

    if (closeBtn) closeBtn.addEventListener('click', closeLightbox);
    if (lightbox) lightbox.addEventListener('click', (e) => { if (e.target === lightbox) closeLightbox(); });

    function closeLightbox() {
      lightbox?.classList.remove('active');
      if (lightboxVideo) { lightboxVideo.pause(); lightboxVideo.src = ''; lightboxVideo.style.display = 'none'; }
      if (iframeContainer) { iframeContainer.innerHTML = ''; iframeContainer.style.display = 'none'; }
      document.body.style.overflow = '';
    }

    function displayProductInfo(product) {
      if (!productInfo) return;
      productInfo.innerHTML = `
        <div class="shoppable-product-lightbox-info">
          ${product.image ? `<img src="${product.image}" alt="${product.title}" class="w-full rounded-lg mb-4 object-cover aspect-square">` : ''}
          <h3 class="text-base font-semibold mb-3">
            <a href="/products/${product.handle}" class="hover:underline">${product.title}</a>
          </h3>
          <div class="text-lg font-bold mb-6">
            ${product.compare_at_price ? `<span class="text-gray-500 line-through text-sm mr-2">${formatMoney(product.compare_at_price)}</span>` : ''}
            ${formatMoney(product.price)}
          </div>
          <form class="shoppable-add-to-cart-form" data-product-id="${product.id}">
            <input type="hidden" name="id" value="${product.variantId}">
            <input type="hidden" name="quantity" value="1">
            <button type="submit" class="btn btn--primary w-full">
              <span>{{ 'products.product.add_to_cart' | t }}</span>
            </button>
          </form>
        </div>
      `;

      const form = productInfo.querySelector('.shoppable-add-to-cart-form');
      if (form) {
        form.addEventListener('submit', async (e) => {
          e.preventDefault();
          const button = form.querySelector('button[type="submit"]');
          const originalText = button.innerHTML;

          button.disabled = true;
          button.innerHTML = `<svg class="animate-spin inline-block align-middle" style="width: 16px; height: 16px; margin-right: 8px;" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24"><circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle><path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path></svg><span>{{ 'cart.adding' | t }}</span>`;

          try {
            const response = await fetch('/cart/add.js', { method: 'POST', body: new FormData(form) });
            if (response.ok) {
              button.innerHTML = `<i class="ph ph-check mr-2"></i><span>{{ 'cart.added' | t }}</span>`;
              document.dispatchEvent(new CustomEvent('cart:refresh'));
              if (typeof window.openCartDrawer === 'function') {
                setTimeout(() => { closeLightbox(); window.openCartDrawer(); }, 500);
              } else {
                setTimeout(() => { button.innerHTML = originalText; button.disabled = false; }, 2000);
              }
            } else {
              button.innerHTML = `<span>{{ 'cart.error' | t }}</span>`;
              setTimeout(() => { button.innerHTML = originalText; button.disabled = false; }, 2000);
            }
          } catch {
            button.innerHTML = `<span>{{ 'cart.error' | t }}</span>`;
            setTimeout(() => { button.innerHTML = originalText; button.disabled = false; }, 2000);
          }
        });
      }
    }

    function formatMoney(cents) {
      if (typeof Shopify !== 'undefined' && Shopify.formatMoney) return Shopify.formatMoney(cents, {{ shop.money_format | json }});
      return new Intl.NumberFormat('{{ request.locale.iso_code | default: "en-US" }}', { style: 'currency', currency: '{{ cart.currency.iso_code | default: "USD" }}' }).format(cents / 100);
    }
  }

  if (document.readyState === 'loading') document.addEventListener('DOMContentLoaded', initShoppableVideosSlider);
  else setTimeout(initShoppableVideosSlider, 100);

  window.addEventListener('swup:contentReplaced', () => setTimeout(initShoppableVideosSlider, 100));
})();
</script>

{% schema %}
{
  "name": "Shoppable Videos",
  "tag": "section",
  "class": "shoppable-videos-section",
  "settings": [
    {
      "type": "header",
      "content": "Header"
    },
    {
      "type": "text",
      "id": "label",
      "label": "Label",
      "default": "Shop the look"
    },
    {
      "type": "text",
      "id": "title",
      "label": "Title",
      "default": "Shoppable Videos"
    },
    {
      "type": "textarea",
      "id": "description",
      "label": "Description"
    },
    {
      "type": "select",
      "id": "header_alignment",
      "options": [
        { "value": "left", "label": "Left" },
        { "value": "center", "label": "Center" }
      ],
      "default": "left",
      "label": "Header alignment"
    },
    {
      "type": "header",
      "content": "Layout"
    },
    {
      "type": "select",
      "id": "videos_desktop",
      "label": "Videos per row (Desktop)",
      "options": [
        { "value": "2", "label": "2" },
        { "value": "3", "label": "3" },
        { "value": "4", "label": "4" },
        { "value": "5", "label": "5" },
        { "value": "6", "label": "6" }
      ],
      "default": "4"
    },
    {
      "type": "select",
      "id": "videos_tablet",
      "label": "Videos per row (Tablet)",
      "options": [
        { "value": "2", "label": "2" },
        { "value": "3", "label": "3" },
        { "value": "4", "label": "4" }
      ],
      "default": "3"
    },
    {
      "type": "select",
      "id": "videos_mobile",
      "label": "Videos per row (Mobile)",
      "options": [
        { "value": "1", "label": "1 (peek nearby)" },
        { "value": "2", "label": "2" }
      ],
      "default": "1"
    },
    {
      "type": "select",
      "id": "video_spacing",
      "label": "Gap between videos",
      "options": [
        { "value": "none", "label": "None" },
        { "value": "small", "label": "Small" },
        { "value": "medium", "label": "Medium" },
        { "value": "large", "label": "Large" }
      ],
      "default": "medium"
    },
    {
      "type": "select",
      "id": "video_aspect_ratio",
      "label": "Video aspect ratio",
      "options": [
        { "value": "9/16", "label": "9:16 (Portrait)" },
        { "value": "3/4", "label": "3:4 (Instagram)" },
        { "value": "1/1", "label": "1:1 (Square)" },
        { "value": "4/3", "label": "4:3 (Standard)" },
        { "value": "16/9", "label": "16:9 (Landscape)" }
      ],
      "default": "9/16"
    },
    {
      "type": "checkbox",
      "id": "full_width",
      "label": "Full width",
      "default": false
    },
    {
      "type": "checkbox",
      "id": "show_product_info",
      "label": "Show product info on cards",
      "default": true
    },
    {
      "type": "header",
      "content": "Auto-scroll"
    },
    {
      "type": "checkbox",
      "id": "enable_marquee",
      "label": "Enable auto-scrolling",
      "default": false
    },
    {
      "type": "range",
      "id": "marquee_speed",
      "label": "Auto-scroll speed",
      "min": 1,
      "max": 100,
      "step": 1,
      "default": 20,
      "unit": "%"
    },
    {
      "type": "checkbox",
      "id": "pause_on_hover",
      "label": "Pause on hover",
      "default": true
    },
    {
      "type": "header",
      "content": "Colors"
    },
    {
      "type": "color",
      "id": "background_color",
      "label": "Background color",
      "default": "#ffffff"
    },
    {
      "type": "color",
      "id": "text_color",
      "label": "Text color",
      "default": "#000000"
    }
  ],
  "blocks": [
    {
      "type": "video",
      "name": "Video",
      "settings": [
        {
          "type": "video_url",
          "id": "video_url",
          "label": "Video URL",
          "accept": ["youtube", "vimeo"],
          "info": "Paste a YouTube or Vimeo URL"
        },
        {
          "type": "video",
          "id": "video_hosted",
          "label": "Or upload video",
          "info": "Upload MP4 video to Shopify"
        },
        {
          "type": "text",
          "id": "alt_text",
          "label": "Alt text",
          "info": "Describe the video for accessibility"
        },
        {
          "type": "product",
          "id": "product",
          "label": "Product"
        }
      ]
    }
  ],
  "presets": [
    {
      "name": "Shoppable Videos",
      "category": "Image & media",
      "blocks": [
        { "type": "video" },
        { "type": "video" },
        { "type": "video" },
        { "type": "video" }
      ]
    }
  ]
}
{% endschema %}
