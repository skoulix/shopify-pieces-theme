{%- comment -%}
  Share Popup Snippet
  Renders a share button with popup containing multiple share options

  Usage:
    {% render 'share-popup', share_url: product.url, share_title: product.title, share_image: product.featured_image %}

  Parameters:
    - share_url: URL to share (required)
    - share_title: Title for the share (required)
    - share_image: Image URL for Pinterest (optional)
    - class: Additional CSS classes for the wrapper (optional)
{%- endcomment -%}

{%- liquid
  assign full_share_url = shop.url | append: share_url
  assign encoded_title = share_title | url_encode
  if share_image
    assign share_image_url = share_image | image_url: width: 1200
  endif
-%}

<div class="relative{% if class %} {{ class }}{% endif %}" data-share-wrapper>
  <button
    type="button"
    class="product-share-btn inline-flex items-center justify-center w-10 h-10 border border-(--color-border) rounded-full text-sm transition-all duration-300 hover:border-(--color-text) hover:bg-(--color-text) hover:text-(--color-background)"
    data-share-trigger
    data-share-url="{{ full_share_url }}"
    data-share-title="{{ share_title | escape }}"
    aria-label="{{ 'products.product.share' | t | default: 'Share' }}"
    aria-expanded="false"
    aria-haspopup="true">
    <i class="ph ph-share-network text-lg" aria-hidden="true"></i>
  </button>
</div>

{%- comment -%} Share popup rendered outside section via portal {%- endcomment -%}
<template data-share-popup-template>
  <div
    class="share-popup fixed bg-(--color-background) border border-(--color-border) shadow-xl p-4 opacity-0 invisible translate-y-2 transition-all duration-200 z-9999 min-w-[200px]"
    data-share-popup
    role="menu">
    <p class="text-sm font-semibold uppercase tracking-widest text-(--color-text-secondary) mb-3">{{ 'general.share' | t }}</p>
    <div class="flex flex-col gap-2">
      <a
        href="https://www.facebook.com/sharer/sharer.php?u={{ full_share_url }}"
        target="_blank"
        rel="noopener"
        class="flex items-center gap-3 py-2 px-3 text-sm text-(--color-text) hover:bg-(--color-background-secondary) transition-colors duration-200"
        role="menuitem"
        aria-label="{{ 'accessibility.share_on_facebook' | t }}">
        <i class="ph ph-facebook-logo text-lg"></i>
        <span>Facebook</span>
      </a>
      <a
        href="https://twitter.com/intent/tweet?url={{ full_share_url }}&text={{ encoded_title }}"
        target="_blank"
        rel="noopener"
        class="flex items-center gap-3 py-2 px-3 text-sm text-(--color-text) hover:bg-(--color-background-secondary) transition-colors duration-200"
        role="menuitem"
        aria-label="{{ 'accessibility.share_on_twitter' | t }}">
        <i class="ph ph-x-logo text-lg"></i>
        <span>X (Twitter)</span>
      </a>
      {% if share_image %}
      <a
        href="https://pinterest.com/pin/create/button/?url={{ full_share_url }}&media={{ share_image_url }}&description={{ encoded_title }}"
        target="_blank"
        rel="noopener"
        class="flex items-center gap-3 py-2 px-3 text-sm text-(--color-text) hover:bg-(--color-background-secondary) transition-colors duration-200"
        role="menuitem"
        aria-label="{{ 'accessibility.share_on_pinterest' | t }}">
        <i class="ph ph-pinterest-logo text-lg"></i>
        <span>Pinterest</span>
      </a>
      {% endif %}
      <a
        href="https://www.linkedin.com/shareArticle?mini=true&url={{ full_share_url }}&title={{ encoded_title }}"
        target="_blank"
        rel="noopener"
        class="flex items-center gap-3 py-2 px-3 text-sm text-(--color-text) hover:bg-(--color-background-secondary) transition-colors duration-200"
        role="menuitem"
        aria-label="{{ 'accessibility.share_on_linkedin' | t }}">
        <i class="ph ph-linkedin-logo text-lg"></i>
        <span>LinkedIn</span>
      </a>
      <a
        href="mailto:?subject={{ encoded_title }}&body={{ full_share_url }}"
        class="flex items-center gap-3 py-2 px-3 text-sm text-(--color-text) hover:bg-(--color-background-secondary) transition-colors duration-200"
        role="menuitem"
        aria-label="{{ 'accessibility.share_via_email' | t }}">
        <i class="ph ph-envelope text-lg"></i>
        <span>Email</span>
      </a>
      <button
        type="button"
        class="flex items-center gap-3 py-2 px-3 text-sm text-(--color-text) hover:bg-(--color-background-secondary) transition-colors duration-200 w-full text-left"
        data-copy-link="{{ full_share_url }}"
        role="menuitem"
        aria-label="{{ 'accessibility.copy_link' | t }}">
        <i class="ph ph-link text-lg"></i>
        <span data-copy-text>{{ 'accessibility.copy_link' | t }}</span>
      </button>
    </div>
  </div>
</template>

<script>
(function() {
  const shareWrapper = document.currentScript.previousElementSibling.previousElementSibling;
  const shareTemplate = document.currentScript.previousElementSibling;

  if (shareWrapper && shareTemplate && shareWrapper.dataset.shareWrapper !== undefined) {
    const shareTrigger = shareWrapper.querySelector('[data-share-trigger]');
    let sharePopup = null;
    let isOpen = false;

    // Create popup from template and append to body
    function createPopup() {
      if (sharePopup) return;
      const content = shareTemplate.content.cloneNode(true);
      sharePopup = content.querySelector('[data-share-popup]');
      document.body.appendChild(sharePopup);

      // Copy link functionality
      const copyLinkBtn = sharePopup.querySelector('[data-copy-link]');
      const copyText = sharePopup.querySelector('[data-copy-text]');
      if (copyLinkBtn) {
        const originalText = copyText?.textContent;
        copyLinkBtn.addEventListener('click', async () => {
          const url = copyLinkBtn.dataset.copyLink;
          try {
            await navigator.clipboard.writeText(url);
            if (copyText) {
              copyText.textContent = {{ 'accessibility.link_copied' | t | json }};
              setTimeout(() => {
                copyText.textContent = originalText;
              }, 2000);
            }
          } catch (err) {
            console.error('Failed to copy:', err);
          }
        });
      }
    }

    function positionPopup() {
      if (!sharePopup) return;
      const rect = shareTrigger.getBoundingClientRect();
      const popupWidth = 200;
      let left = rect.right - popupWidth;
      // Keep popup in viewport
      if (left < 10) left = 10;
      if (left + popupWidth > window.innerWidth - 10) {
        left = window.innerWidth - popupWidth - 10;
      }
      sharePopup.style.top = `${rect.bottom + 8}px`;
      sharePopup.style.left = `${left}px`;
    }

    function openPopup() {
      createPopup();
      positionPopup();
      isOpen = true;
      sharePopup.classList.remove('opacity-0', 'invisible', 'translate-y-2');
      sharePopup.classList.add('opacity-100', 'visible', 'translate-y-0');
      shareTrigger.setAttribute('aria-expanded', 'true');
    }

    function closePopup() {
      if (!sharePopup) return;
      isOpen = false;
      sharePopup.classList.add('opacity-0', 'invisible', 'translate-y-2');
      sharePopup.classList.remove('opacity-100', 'visible', 'translate-y-0');
      shareTrigger.setAttribute('aria-expanded', 'false');
    }

    // Try native share API first (mobile/modern browsers)
    shareTrigger.addEventListener('click', async () => {
      if (navigator.share) {
        try {
          await navigator.share({
            title: shareTrigger.dataset.shareTitle || document.title,
            url: shareTrigger.dataset.shareUrl || window.location.href
          });
          return;
        } catch (err) {
          // User cancelled or error - fall back to popup
          if (err.name === 'AbortError') return;
        }
      }
      // Fallback to popup
      if (isOpen) {
        closePopup();
      } else {
        openPopup();
      }
    });

    // Close on click outside
    document.addEventListener('click', (e) => {
      if (isOpen && !shareWrapper.contains(e.target) && sharePopup && !sharePopup.contains(e.target)) {
        closePopup();
      }
    });

    // Close on escape
    document.addEventListener('keydown', (e) => {
      if (isOpen && e.key === 'Escape') {
        closePopup();
        shareTrigger.focus();
      }
    });

    // Reposition on scroll/resize
    window.addEventListener('scroll', () => {
      if (isOpen) positionPopup();
    }, { passive: true });

    window.addEventListener('resize', () => {
      if (isOpen) positionPopup();
    });
  }
})();
</script>
