{%- comment -%}
  Renders the country picker for the localization form - Tailwind Version

  Accepts:
    - localPosition: pass in the position in which the form is coming up to create specific IDs
{%- endcomment -%}

{%- liquid
  assign currencies = localization.available_countries | map: 'currency' | map: 'iso_code' | uniq
  assign popular_countries = localization.available_countries | where: 'popular?' | sort: 'name'

  assign show_country_filter = false
  if localization.available_countries.size > 9
    assign show_country_filter = true
  endif

  assign show_popular_countries = false
  if localization.available_countries.size > 9 and popular_countries.size > 1
    assign show_popular_countries = true
  endif

  assign show_currencies = false
  if currencies.size > 1
    assign show_currencies = true
  endif
%}

<div class="disclosure relative">
  <button
    type="button"
    class="disclosure__button flex items-center gap-1.5 text-sm text-current hover:opacity-70 transition-opacity"
    aria-expanded="false"
    aria-controls="{{ localPosition }}-country-results"
    aria-describedby="{{ localPosition }}Label"
  >
    <span>
      {{- localization.country.name }} |
      {{ localization.country.currency.iso_code }}
      {{ localization.country.currency.symbol -}}
    </span>
    {%- render 'icon', name: 'caret-down', size: '16' -%}
  </button>

  <div class="disclosure__list-wrapper country-selector absolute bottom-full mb-2 right-0 bg-white rounded-xl shadow-lg border border-neutral-200 min-w-[280px] max-h-[400px] overflow-hidden z-50" hidden>
    {%- comment -%} Header with Search {%- endcomment -%}
    <div class="flex items-center justify-between gap-3 p-3 border-b border-neutral-100">
      {%- if show_country_filter -%}
        <div class="relative flex-1">
          <input
            class="w-full h-9 pl-9 pr-8 bg-neutral-100 border-0 rounded-lg text-sm placeholder:text-neutral-400 focus:outline-none focus:ring-2 focus:ring-neutral-900"
            id="country-filter-input"
            type="search"
            name="country_filter"
            value=""
            placeholder="{{ 'localization.search' | t }}"
            role="combobox"
            aria-owns="country-results"
            aria-controls="country-results"
            aria-haspopup="listbox"
            aria-autocomplete="list"
            autocorrect="off"
            autocomplete="off"
            autocapitalize="off"
            spellcheck="false"
          >
          <label class="sr-only" for="country-filter-input">{{ 'localization.search' | t }}</label>
          <div class="absolute left-3 top-1/2 -translate-y-1/2 text-neutral-400 pointer-events-none">
            {%- render 'icon', name: 'magnifying-glass', size: '16' -%}
          </div>
          <button
            type="reset"
            class="country-filter__reset-button absolute right-2 top-1/2 -translate-y-1/2 p-1 text-neutral-400 hover:text-neutral-600 hidden"
            aria-label="{{ 'general.search.reset' | t }}"
          >
            {%- render 'icon', name: 'x', size: '14' -%}
          </button>
        </div>
      {%- endif -%}
      <button
        class="country-selector__close-button p-1.5 text-neutral-400 hover:text-neutral-600 hover:bg-neutral-100 rounded-lg transition-colors"
        type="button"
        aria-label="{{ 'accessibility.close' | t }}"
      >
        {%- render 'icon', name: 'x', size: '18' -%}
      </button>
    </div>

    <div id="sr-country-search-results" class="sr-only" aria-live="polite"></div>

    {%- comment -%} Country List {%- endcomment -%}
    <div
      class="disclosure__list max-h-[320px] overflow-y-auto p-2"
      id="{{ localPosition }}-country-results"
    >
      {%- if show_popular_countries -%}
        <div class="mb-2 pb-2 border-b border-neutral-100">
          <p class="px-2 py-1 text-xs font-medium uppercase tracking-wider text-neutral-400">
            {{ 'localization.popular_countries_regions' | t }}
          </p>
          <ul role="list" class="popular-countries space-y-0.5">
            {%- for country in popular_countries -%}
              <li class="disclosure__item" tabindex="-1">
                <a
                  class="flex items-center gap-2 px-2 py-2 rounded-lg text-sm text-neutral-700 hover:bg-neutral-100 transition-colors{% if country.iso_code == localization.country.iso_code %} bg-neutral-100 font-medium{% endif %}"
                  href="#"
                  {% if country.iso_code == localization.country.iso_code %}aria-current="true"{% endif %}
                  data-value="{{ country.iso_code }}"
                  id="{{ country.name }}"
                >
                  <span class="w-4 flex-shrink-0 {% if country.iso_code != localization.country.iso_code %}invisible{% endif %}">
                    {%- render 'icon', name: 'check', size: '16' -%}
                  </span>
                  <span class="flex-1">{{ country.name }}</span>
                  {%- if show_currencies -%}
                    <span class="text-neutral-400 text-xs">
                      {{ country.currency.iso_code }} {{ country.currency.symbol }}
                    </span>
                  {%- endif -%}
                </a>
              </li>
            {%- endfor -%}
          </ul>
        </div>
      {%- endif -%}

      <ul role="list" class="countries space-y-0.5">
        {%- for country in localization.available_countries -%}
          <li class="disclosure__item" tabindex="-1">
            <a
              class="flex items-center gap-2 px-2 py-2 rounded-lg text-sm text-neutral-700 hover:bg-neutral-100 transition-colors{% if country.iso_code == localization.country.iso_code %} bg-neutral-100 font-medium{% endif %}"
              href="#"
              {% if country.iso_code == localization.country.iso_code %}aria-current="true"{% endif %}
              data-value="{{ country.iso_code }}"
              id="{{ country.name }}"
            >
              <span class="w-4 flex-shrink-0 {% if country.iso_code != localization.country.iso_code %}invisible{% endif %}">
                {%- render 'icon', name: 'check', size: '16' -%}
              </span>
              <span class="country flex-1">{{ country.name }}</span>
              {%- if show_currencies -%}
                <span class="text-neutral-400 text-xs">
                  {{ country.currency.iso_code }} {{ country.currency.symbol }}
                </span>
              {%- endif -%}
            </a>
          </li>
        {%- endfor -%}
      </ul>
    </div>
  </div>
  <div class="country-selector__overlay fixed inset-0 bg-black/20 z-40 hidden"></div>
</div>
<input type="hidden" name="country_code" value="{{ localization.country.iso_code }}">
