{% comment %}theme-check-disable ImgLazyLoading{% endcomment %}
{% comment %}
  Renders a product thumbnail with GLightbox integration - Tailwind version
  Modern, minimal design with hover effects

  Accepts:
  - media: {Object} Product Media object
  - media_count: {Number} Number of media objects
  - position: {String} Position of the media. Used for accessible label.
  - desktop_layout: {String} Layout of the media for desktop.
  - mobile_layout: {String} Layout of the media for mobile.
  - loop: {Boolean} Enable video looping (optional)
  - modal_id: {String} Section ID for unique identifiers
  - xr_button: {Boolean} Renders the "View in your space" button (shopify-xr-button) if the media is a 3D Model
  - constrain_to_viewport: {Boolean} Force media height to fit within viewport
  - media_fit: {String} Method ("contain" or "cover") to fit image into container
  - lazy_load: {Boolean} Image should be lazy loaded. Default: true (optional)

  Usage:
  {% render 'product-thumbnail',
    media: media,
    position: forloop.index,
    loop: section.settings.enable_video_looping,
    modal_id: section.id
  %}
{% endcomment %}

{%- liquid
  unless lazy_load == false
    assign lazy = 'lazy'
  endunless

  assign desktop_columns = 1
  if desktop_layout == 'columns' and media_count > 1
    assign desktop_columns = 2
  endif

  assign mobile_columns = 1
  if mobile_layout == 'columns' and media_count > 1
    assign mobile_columns = 2
  endif

  assign object_fit = 'object-cover'
  if media_fit == 'contain'
    assign object_fit = 'object-contain'
  endif
-%}

{%- capture sizes -%}
  (min-width: {{ settings.page_width }}px) {{ settings.page_width | minus: 100 | divided_by: desktop_columns | round }}px, (min-width: 990px) calc(50vw - 10rem), (min-width: 750px) calc((100vw - 11.5rem) / 2), calc(100vw / {{ mobile_columns }} - 4rem)
{%- endcapture -%}

{%- capture image_class -%}{{ object_fit }} w-full h-full transition-transform duration-500 group-hover:scale-105{%- endcapture -%}
{%- capture poster_class -%}{{ object_fit }} w-full h-full{%- endcapture -%}

<div
  class="group relative bg-neutral-100 rounded-xl overflow-hidden {% if constrain_to_viewport %}max-h-[80vh]{% endif %}"
  style="aspect-ratio: {{ media.aspect_ratio | default: 1.0 }};"
>
  {%- if media.media_type == 'image' -%}
    {%- comment -%} Image with Lightbox {%- endcomment -%}
    <a
      href="{{ media | image_url: width: 2048 }}"
      class="block w-full h-full cursor-zoom-in"
      data-lightbox
      data-no-swup
      data-pswp-width="{{ media.width | default: 1920 }}"
      data-pswp-height="{{ media.height | default: 1280 }}"
      data-media-type="image"
      data-alt="{{ media.alt | escape }}"
      data-media-id="{{ media.id }}"
    >
      {%- comment -%} Zoom Icon {%- endcomment -%}
      <span
        class="absolute top-4 right-4 z-10 p-2 bg-white/80 backdrop-blur-sm rounded-full text-neutral-700 opacity-0 group-hover:opacity-100 transition-opacity quick-add-hidden"
        aria-hidden="true"
      >
        {%- render 'icon', name: 'magnifying-glass-plus', size: '20' -%}
      </span>

      {%- comment -%} Image {%- endcomment -%}
      <div class="w-full h-full">
        {{
          media.preview_image
          | image_url: width: 1946
          | image_tag:
            class: image_class,
            loading: lazy,
            sizes: sizes,
            widths: '246, 493, 600, 713, 823, 990, 1100, 1206, 1346, 1426, 1646, 1946'
        }}
      </div>

      <span class="sr-only">
        {{ 'products.product.media.open_media' | t: index: position }}
      </span>
    </a>

  {%- elsif media.media_type == 'video' or media.media_type == 'external_video' -%}
    {%- comment -%} Video - plays inline, lightbox for external videos {%- endcomment -%}
    {%- if media.media_type == 'external_video' -%}
      {%- comment -%} External Video (YouTube/Vimeo) - Lightbox {%- endcomment -%}
      <a
        href="{% if media.host == 'youtube' %}https://www.youtube.com/watch?v={{ media.external_id }}{% else %}https://vimeo.com/{{ media.external_id }}{% endif %}"
        class="block w-full h-full cursor-pointer"
        data-lightbox
        data-no-swup
        data-src="{% if media.host == 'youtube' %}https://www.youtube.com/watch?v={{ media.external_id }}{% else %}https://vimeo.com/{{ media.external_id }}{% endif %}"
        data-media-type="external_video"
        data-video-host="{{ media.host }}"
        data-alt="{{ media.alt | escape }}"
        data-media-id="{{ media.id }}"
      >
        {%- comment -%} Play Icon {%- endcomment -%}
        <span class="absolute inset-0 flex items-center justify-center z-10">
          <span class="flex items-center justify-center w-16 h-16 bg-white/90 backdrop-blur-sm rounded-full text-neutral-900 shadow-lg group-hover:scale-110 transition-transform">
            {%- render 'icon', name: 'play', size: '24' -%}
          </span>
        </span>

        {%- comment -%} Poster Image {%- endcomment -%}
        <div class="w-full h-full">
          {{
            media.preview_image
            | image_url: width: 1946
            | image_tag:
              class: poster_class,
              loading: lazy,
              sizes: sizes,
              widths: '246, 493, 600, 713, 823, 990, 1100, 1206, 1346, 1426, 1646, 1946'
          }}
        </div>

        <span class="sr-only">
          {{ 'products.product.media.play_video' | t }}
        </span>
      </a>

    {%- else -%}
      {%- comment -%} Native Video - Lightbox {%- endcomment -%}
      {%- assign video_sources = media.sources | where: 'format', 'mp4' -%}
      {%- assign video_url = video_sources.first.url | default: media.sources.first.url -%}
      <a
        href="{{ video_url }}"
        class="block w-full h-full cursor-pointer"
        data-lightbox
        data-no-swup
        data-src="{{ video_url }}"
        data-media-type="video"
        data-video-host="local"
        data-alt="{{ media.alt | escape }}"
        data-media-id="{{ media.id }}"
      >
        {%- comment -%} Play Icon {%- endcomment -%}
        <span class="absolute inset-0 flex items-center justify-center z-10">
          <span class="flex items-center justify-center w-16 h-16 bg-white/90 backdrop-blur-sm rounded-full text-neutral-900 shadow-lg group-hover:scale-110 transition-transform">
            {%- render 'icon', name: 'play', size: '24' -%}
          </span>
        </span>

        {%- comment -%} Poster Image {%- endcomment -%}
        <div class="w-full h-full">
          {{
            media.preview_image
            | image_url: width: 1946
            | image_tag:
              class: poster_class,
              loading: lazy,
              sizes: sizes,
              widths: '246, 493, 600, 713, 823, 990, 1100, 1206, 1346, 1426, 1646, 1946'
          }}
        </div>

        <span class="sr-only">
          {{ 'products.product.media.play_video' | t }}
        </span>
      </a>
    {%- endif -%}

  {%- elsif media.media_type == 'model' -%}
    {%- comment -%} 3D Model - interactive inline {%- endcomment -%}
    <product-model class="block w-full h-full deferred-media" data-media-id="{{ media.id }}">
      <button id="Deferred-Poster-Modal-{{ media.id }}" class="w-full h-full group/play" type="button">
        {%- comment -%} 3D Icon Overlay {%- endcomment -%}
        <span class="absolute inset-0 flex items-center justify-center z-10">
          <span class="flex items-center justify-center w-16 h-16 bg-white/90 backdrop-blur-sm rounded-full text-neutral-900 shadow-lg group-hover/play:scale-110 transition-transform">
            <span class="sr-only">{{ 'products.product.media.play_model' | t }}</span>
            {%- render 'icon', name: 'cube', size: '24' -%}
          </span>
        </span>

        {%- comment -%} Poster Image {%- endcomment -%}
        {{
          media.preview_image
          | image_url: width: 1946
          | image_tag:
            class: poster_class,
            loading: lazy,
            sizes: sizes,
            widths: '246, 493, 600, 713, 823, 990, 1100, 1206, 1346, 1426, 1646, 1946'
        }}
      </button>

      <template>
        {{ media | media_tag: image_size: '2048x', toggleable: true }}
      </template>
    </product-model>

    {%- if xr_button -%}
      <button
        class="absolute bottom-4 left-4 right-4 flex items-center justify-center gap-2 py-3 px-4 bg-white text-neutral-900 text-sm font-medium rounded-lg shadow-lg hover:bg-neutral-50 transition-colors z-10"
        type="button"
        aria-label="{{ 'products.product.xr_button_label' | t }}"
        data-shopify-xr
        data-shopify-model3d-id="{{ media.id }}"
        data-shopify-title="{{ product.title | escape }}"
        data-shopify-xr-hidden
      >
        {%- render 'icon', name: 'cube', size: '20' -%}
        {{ 'products.product.xr_button' | t }}
      </button>
    {%- endif -%}
  {%- endif -%}
</div>
